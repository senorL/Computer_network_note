# 概述

![Pasted image](images/Pasted%20image%2020231014194455.png)
- 链路是指从一个节点到相邻节点的一段物理线路（有线或者无线），而中间没有任何其他的交换节点
- 数据链路是基于链路的。当在一条链路上传输数据时，除需要链路本身，还需要一些必要的通信协议来控制这些数据的传输，把实现这些协议的硬件和软件加到链路上，就构成了数据链路
- 计算机的网络适配器（网卡）和其相应的软件驱动程序就实现了这些协议。一般的网络适配器都包含了物理层和数据链路层这两层功能
- 帧是数据链路层对等实体之间在水平方向进行逻辑通信的协议数据单元PDU
![Pasted image](images/Pasted%20image%2020231014194919.png)
# 三个重要问题
## 封装成帧和透明传输
### 封装成帧
- 帧定界：从物理层传输上来的比特流中根据标志字段识别出帧的首部和尾部
- 封装成帧是指数据链路层给上层交付下来的协议数据单元PDU添加一个首部和一个尾部，使之成为帧
	- 帧的首部和尾部中包含有一些重要的控制信息
	- 作用之一是帧定界
- 为了提高传输帧的效率，应当使帧的数据载荷长度尽可能大于首部和尾部的长度
- 每一种数据链路层协议都规定了帧的数据载荷的长度上限，即最大传送单元MTU
ppp帧有帧定界标志，但以太网V2的MAC帧没有帧定界标志，其在物理层会添加帧开始定界符的前导码，并且规定了96b的发送时间作为帧间间隔

![Pasted image](images/Pasted%20image%2020231014195426.png)
### 透明传输
- 面向字节的物理链路使用字节填充的方法实现透明传输。在数据载荷中的每一个帧定界符或转义字符前插入一个转义字符
- 面向比特的物理链路使用比特填充的方法实现透明传输。在连续的五个1后面添加一个0
![Pasted image](images/Pasted%20image%2020231014201115.png)
![Pasted image](images/Pasted%20image%2020231014195548.png)
## 差错检测
- 实际的通信链路中会出现比特差错
- 在一段时间内，传输错误的比特数量占所传输比特总数的比率成为误码率（BER）
- 提高链路的信噪比，可以降低误码率。但不可能下降为零
- 使用差错检测技术来检测数据在传输过程中是否产生了比特差错
- FCS（帧检测序列）
![Pasted image](images/Pasted%20image%2020231014195700.png)
### 奇偶校验
![Pasted image](images/Pasted%20image%2020231014202232.png)
![Pasted image](images/Pasted%20image%2020231014202240.png)
如果奇数个位发生误码，则所包含比特1的数量的奇偶性会发生改变，可以检测出误码。如果偶数个位发生误码，则相反，无法检测出误码（漏检）
### 循环冗余校验
- 数据链路层广泛使用漏检率极低的循环冗余校验（CRC）检错技术
![Pasted image](images/Pasted%20image%2020231014202747.png)
![Pasted image](images/Pasted%20image%2020231014202818.png)
![Pasted image](images/Pasted%20image%2020231014202847.png)
![Pasted image](images/Pasted%20image%2020231025180223.png)
### 总结：
![Pasted image](images/Pasted%20image%2020231014203308.png)
## 可靠传输
如果检测到帧的传输过程中产生了误码，那么会根据数据链路层向其上层提供的服务类型做出反应
- 不可靠传输服务：仅仅丢弃有误码的帧
- 可靠传输服务：通过某种机制实现发送方发送什么，接收方最终就能收到什么
- 有线链路误码率比较低，并不要求数据链路层向其上层提供可靠传输服务
- 无线链路易受干扰，误码率比较高，要求数据链路层必须向其上层提供可靠传输服务

传输差错包括： 误码，分组丢失，分组时序，分组重复

### 停止-等待（SW）协议
原理：
![Pasted image](images/Pasted%20image%2020231014204827.png)
超时重传机制
![Pasted image](images/Pasted%20image%2020231014204928.png)
一般可将RTO设置为略大于收发双方的平均往返时间RTT
确认丢失机制
![Pasted image](images/Pasted%20image%2020231014205220.png)
丢弃重复的数据分组，再发送一个确认分组，同理，对ACK也需要编号
![Pasted image](images/Pasted%20image%2020231014205342.png)
![Pasted image](images/Pasted%20image%2020231014205522.png)
信道利用率
![Pasted image](images/Pasted%20image%2020231014205708.png)
RTT较大时，不适用SW协议

### 回退N帧协议（GBN）

![Pasted image](images/Pasted%20image%2020231014210533.png)
![Pasted image](images/Pasted%20image%2020231014211346.png)
当wt等于1时，是停止-等待协议，大于最大值时，会造成分组重复

![Pasted image](images/Pasted%20image%2020231014210809.png)
![Pasted image](images/Pasted%20image%2020231014210858.png)
一旦出错，需要退回重传已发送过的N个数据分组
![Pasted image](images/Pasted%20image%2020231014211243.png)
![Pasted image](images/Pasted%20image%2020231014211326.png)
### 选择重传协议（SR）
![Pasted image](images/Pasted%20image%2020231014212349.png)
为了能使发送方仅重传出现差错的数据分组，接收方不再使用累计确认，而需要对每一个正确接收的数据分组进行逐一确认，如g果发送窗口尺寸大于取值上限时，接收方将无法分辨新旧数据分组

# 点对点协议PPP
目前使用最广泛的点对点数据链路层协议，目前是因特网的正式标准
![Pasted image](images/Pasted%20image%2020231015183239.png)
![Pasted image](images/Pasted%20image%2020231015183321.png)
![Pasted image](images/Pasted%20image%2020231015183458.png)
透明传输
![Pasted image](images/Pasted%20image%2020231015183650.png)
![Pasted image](images/Pasted%20image%2020231015183723.png)
差错检测
接收方每收到一个PPP帧，就进行CRC校验，若CRC校验正确，就收下这个帧；否则，就丢弃这个帧。使用PPP的数据链路层，向上提供的是不可靠数据传输服务
工作机制
![Pasted image](images/Pasted%20image%2020231015184022.png)

# 网络适配器和MAC地址
## 网络适配器
要将计算机连接到以太网，需要使用相应的网络适配器，简称”网卡“
![Pasted image](images/Pasted%20image%2020231015184448.png)
计算机内部中，网卡与CPU之间的通信，一般是通过计算机主板上的I/O总线以并行传输方式进行，网卡与外部以太网之间的通信一般是串行方式。
网卡除了要实现物理层和数据链路层的功能，还有就是并行传输和串行传输的转换。
为了使显卡正常工作，还必须安装相应的驱动，驱动程序负责驱动网卡发送和接受帧。

## MAC地址

- 当多个主机连接到同一个广播信道上，要想实现两个主机之间的通信，每个主机必须有一个唯一的标识，即一个数据链路层地址
- 在每个主机发送的帧的首部中，都携带有发送主机和接收主机的数据链路层地址，这类地址是用于媒体接入控制（MAC）的，因此被称作MAC地址（也被称为硬件地址/物理地址）
- 通常包括两块网卡，分别是以太网卡和WIFI网卡
- 每个网卡都有全球唯一的MAC地址
- 对各接口的唯一标识![Pasted image](images/Pasted%20image%2020231015190303.png)
![Pasted%20image](images/Pasted%20image%20images/Pasted%20image%2020231015190743.png)![Pasted%20image](images/Pasted%20image%2020231015190844.png.png)
![Pasted image](images/Pasted%20image%2020231015191018.png)
![Pasted image](images/Pasted%20image%2020231015191051.png)
![Pasted image](images/Pasted%20image%2020231015191144.png)

# CSMA/CD 协议的基本原理
为了解决各个站点争用总线的问题，共享总线以太网使用了一种专用协议CSMA/CD，它是载波监听多址接入/碰撞检测的缩写词
![Pasted image](images/Pasted%20image%2020231016200006.png)
![Pasted image](images/Pasted%20image%2020231016200159.png)
强化碰撞：发送帧的站点一旦检测到碰撞，除了立即停止发送帧外，还要再发送32/48比特的人为干扰信号，以便有足够多的碰撞信号是所有站点都能检测到碰撞
![Pasted image](images/Pasted%20image%2020231016200739.png)

# 共享式以太网的争用期，最小帧长和最大帧长
## 争用期
![Pasted image](images/Pasted%20image%2020231016202532.png)
- 如果争用期这段时间还没有检测到碰撞，就可以肯定这次发送不会发生碰撞
- 10mb/s共享总线以太网规定：争用期$2\tau$的值为512比特的发送时间，即51.2$\mu s$
- 总线长度不超过2500m

## 最小帧长和最大帧长

![Pasted image](images/Pasted%20image%2020231017171320.png)
![Pasted image](images/Pasted%20image%2020231017171400.png)
![Pasted image](images/Pasted%20image%2020231017171504.png)
![Pasted image](images/Pasted%20image%2020231017171935.png)
# 共享式以太网的退避算法和信道利用率
## 退避算法
采用截断二进制指数退避算法来退避随机时间
![Pasted image](images/Pasted%20image%2020231017212044.png)
- 使用上述的退避算法可以使重传需要推迟的平均时间随重传次数而增大（动态退避），因而减少产生碰撞的概率
- 当重传16次仍然不能成功时，就表明同时打算发送帧的站点太多，以至于连续产生碰撞，应该放弃重传并且向高层报告
## 信道利用率
![Pasted image](images/Pasted%20image%2020231017212412.png)

# 使用集线器的共享式以太网
![Pasted image](images/Pasted%20image%2020231017212741.png)
![Pasted image](images/Pasted%20image%2020231017212909.png)
# 在物理层扩展以太网
- 共享总线以太网中两站点之间的距离不能太远，否则它们之间所传输的信号就会衰减道使CSMA/CD协议无法正常工作
- 早期常用的是工作在物理层的转发器
- 两个网段可用一个转发器连接起来，任意两个站点之间最多可以经过三个网段
![Pasted image](images/Pasted%20image%2020231017213312.png)
- 采用多个集线器连接而成的多级星型以太网，在扩展了网络覆盖范围和站点数量的同时，也产生了更大的碰撞域，遭遇碰撞的可能性增加，导致平均吞吐量太低

# 在数据链路层上扩展以太网——网桥

- 网桥工作在数据链路层（包括其下的物理层）
- 网桥可以识别帧的结构
- 网桥可以根据帧首部的目的MAC地址和自身的帧转发表来转发或者丢弃所受到的帧
- 转发表：网桥转发的依据
- 如果收到广播帧，不用查找转发表，而是会通过除接收该帧的接口的其他接口转发该广播帧
![Pasted image](images/Pasted%20image%2020231017213826.png)

# 透明网桥的自学习和转发帧的流程与生成树协议STP
## 自学习
- 透明网桥通过自学习算法建立转发表
- "透明"是指以太网中的各网桥对于各站点而言是看不见的
![Pasted image](images/Pasted%20image%2020231017215543.png)
![Pasted image](images/Pasted%20image%2020231017215609.png)
## STP
![Pasted image](images/Pasted%20image%2020231017221216.png)
为了避免广播帧在环路中永久兜圈，透明网桥使用生成树协议（STP）
- 不管网桥之间连接成了怎样复杂的带环拓扑，网桥之间通过交互网桥协议单元（BPDU），找出原网络拓扑的一个连通子集（生成树），在这个子集里整个连通的网络中不存在环路
- 当首次连接网桥或网络拓扑发生变化时，网桥都会重新构造生成树，以确保网络的连通

# 交换式以太网
- 网桥接口很少，一般只用来连接不同网段
- 交换式集线器，实质上是具有多个接口的网桥，称为以太网交换机或二层交换机
- 二层是指以太网交换机工作在数据链路层（包括物理层）
- 交换机内部的转发表也是自学习算法
- 交换机也使用生成树协议STP，来产生能够连通全网但不产生环路的通信路径
- 仅使用交换机的以太网就是交换式以太网

# 以太网交换机
- 交换机的每个接口可以连接计算机，也可以连接集线器或者另一个交换机
- 当交换机的接口与计算机或交换机连接时，可以工作在全双工方式，并能在自身内部同时连通多对接口，使每一对相互通信的计算机都能像独占传输媒体那样，无碰撞地传输数据，这样就不需要使用CSMA/CD协议
- 当交换机的接口连接的是集线器时，该接口就只能使用CSMA/CD协议并只能工作在半双工方式
- 为了减少转发时延，某些交换机采用直通交换方式，接收帧的同时就立即按帧的目的MAC地址决定该帧的转发接口，然后通过其内部基于硬件的交叉矩阵转发，时延非常小，不检查差错就直接将帧转发出去
例题如下：
![Pasted image](images/Pasted%20image%2020231021221044.png)

# 共享式以太网与交换式以太网的对比
- 集线器只工作在物理层，不能识别帧首部中的目的MAC地址，仅转发帧的信号
- 使用集线器扩展共享式以太网既扩大了广播域又扩大了碰撞域，使用交换机扩大了广播域但隔离了碰撞域

# 以太网的MAC帧格式
- 目的地址、源地址：帧的目的MAC地址和源MAC地址
- 类型：指明数据载荷中的内容是由上一层的哪个协议封装的，以便将收到的MAC帧的数据在和上交给上一层的这个协议
- FCS：使用CRC生成的帧检验序列，可检测出帧在传输过程中是否产生了误码
![Pasted image](images/Pasted%20image%2020231021224753.png)
# 虚拟局域网VLAN
## 介绍
巨大的广播域带来一系列问题：
1. 广播风暴：浪费网络资源和各主机的CPU资源
2. 难以维护和管理，带来潜在的安全问题
分割广播域的方法：
1. 使用路由器（网络层）可以隔离广播域（成本较高）
2. 虚拟局域网技术
![Pasted image](images/Pasted%20image%2020231022153659.png)
- 属于同一VLAN的站点之间才可以直接通信
- 对局域网中个交换机配置来建立多个逻辑上独立的VLAN
- 连接在同一交换机上的多个站点可以属于不同的VLAN，属于同一VLAN的多个站点也可以连接在不同的交换机上
- VLAN并不是一种新型网络，他只是局域网能够提供给用户的一种服务

## 实现
最常见的是基于以太网交换机的接口来实现VLAN，需要以太网交换机能具有以下的功能：
1. 能处理带有VLAN标记的帧，也就是IEEE 802.1Q帧
2. 交换机各接口可以支持不同的接口类型
### IEEE 802.1Q帧
![Pasted image](images/Pasted%20image%2020231022154644.png)
![Pasted image](images/Pasted%20image%2020231022154806.png)
![Pasted image](images/Pasted%20image%2020231022154822.png)
当交换机收到普通的以太网MAC帧时，会给其插入4字节的VLAN标签使之成为802.1Q帧，该处理简称为“打标签”；当交换机转发802.1Q帧时，可能会删除其4字节的VLAN标签使之成为普通的以太网MAC帧，简称为“去标签”。是否进行该操作取决于接口类型。
### 以太网交换机的接口类型
![Pasted image](images/Pasted%20image%2020231022161448.png)
例子
![Pasted image](images/Pasted%20image%2020231022161655.png)
![Pasted image](images/Pasted%20image%2020231022161906.png)
### Access接口与Trunk接口
![Pasted image](images/Pasted%20image%2020231022162114.png)
![Pasted image](images/Pasted%20image%2020231022162211.png)
# 以太网的发展
## 100BASE-T以太网
- 100BASE-T以太网是指在双绞线上传输基带信号的速率为100Mb/s的以太网，也称为快速以太网
- 与10Mb/s标准以太网（传统以太网）一样，依然使用IEEE 802.3的帧格式和CSMA/CD协议
- 最小帧长仍为64字节，最大电缆长度100m，争用期5.12$\mu s$，帧间最小间隔为0.96$\mu s$
- 也可以使用以太网交换机在全双工方式下无碰撞工作
![Pasted image](images/Pasted%20image%2020231023155941.png)
## 吉比特以太网
千兆以太网的网段最大长度仍保持为100m，最小帧长仍保持为64字节。
- 载波延伸，将争用期增大为512字节的发送时间而保持最小帧长仍为64字节，只要发送的MAC帧的长度不足512字节，就在尾部填充一些特殊字符。
- 分组突发，当有很多短帧要连续发送时，只需要将第一个短帧用载波延伸的方法进行填充，当累积发送1500字节或稍多一些为止
- 当千兆以太网工作在全双工方式时，不使用CSMA/CD协议，也不会使用载波延伸和分组突发

## 10吉比特以太网
也称作万兆以太网，目标时将以太网从局域网范围扩展到城域网与广域网
- 只工作在全双工方式不存在争用媒体的问题
- 增加了支持城域网和广域网的物理层
- 常作为千兆以太网的汇聚层交换机

## 40/100吉比特以太网
![Pasted image](images/Pasted%20image%2020231023161905.png)

# 802.11无线局域网（WLAN）
802.11无线局域网是目前最广泛的无线局域网之一，简称为Wi-Fi（无线保真度）
## 组成
- 有固定基础设施：预先建立，能够覆盖一定地理范围的，多个固定的通信基站
- 无固定基础设施
### 有固定基础设施
![Pasted image](images/Pasted%20image%2020231023181542.png)
- 本BSS内各站点之间的通信以及与本BSS外的站点之间的通信，都必须经过本BSS内的AP进行转发
- 需要为AP分配一个最大32字节的服务集标识符（SSID）和一个无线通信信道，SSID实际上就是使用该AP的802.11无线局域网的名字
- 一个BSS所覆盖的地理范围成为基本服务区BSA（直径小于100m）
![Pasted image](images/Pasted%20image%2020231023181930.png)
1. 关联服务
	移动站与接入点AP建立关联的方法如下：
	- 被动扫描：AP周期性地发出信标帧（包括SSID，AP的MAC地址，所支持的速率、加密算法和安全配置等参数），移动站被动接收信标帧
	- 主动扫描：移动站主动发出探测请求帧，等待AP的探测响应帧
2. 重建关联服务和分离服务
	一个移动站要把与某个接入点AP的关联转移到另一个AP，就可以使用重建关联服务。如果要终止关联服务，就应该使用分离服务
### 无固定设施
自组织网络（ad hoc Network）
转发站需要具有路由功能
![Pasted image](images/Pasted%20image%2020231023182711.png)

## 物理层
- 依据工作频段、调制方式、传输速率等分成多种物理层标准
- 802.11无线网卡一般做成多模的
- 最初使用红外技术（IR）和跳频扩频（FHSS）技术

## 数据链路层
- 802.11无线局域网使用载波监听多址接入/碰撞避免（CSMA/CA）
- 尽管CA表示碰撞避免，但不能避免所有碰撞，而是尽量减少碰撞发生的概率
- 无线信道的传输环境复杂且信号强度的动态范围非常大，收到的信号强度一般都远远小于发送信号的强度，如果要在802.11无线网卡上实现碰撞检测，对硬件要求分厂高
- 无线电波传播存在隐蔽站问题，还会出现无法检测到碰撞的情况，因此碰撞检测没有意义
![Pasted image](images/Pasted%20image%2020231023184227.png)

## CSMA/CA
![Pasted image](images/Pasted%20image%2020231023184402.png)
等待DIFS间隔是考虑可能有其他的站有高优先级的帧要发送
![Pasted image](images/Pasted%20image%2020231023184552.png)
![Pasted image](images/Pasted%20image%2020231023184827.png)
CSMA/CA协议要使用停止-等待的确认机制来实现可靠传输
![Pasted image](images/Pasted%20image%2020231023184958.png)
![Pasted image](images/Pasted%20image%2020231023185021.png)
### 退避算法
站点为退避计时器设置一个随机的退避时间：
- 当退避计时器的时间减小到零时，就开始发送数据
- 当退避计时器的时间还未减小到零时而信道又转变为忙状态，这时就冻结退避计时器的数值，重新等待信道变为空闲，再经过帧间间隔DIFS后，继续启动退避计时器。
在进行第i次退避时，退避时间在时隙编号{$0,1,...,2^{2+i}-1$}中随机选择一个，然后乘以基本退避时间（也就是一个时隙的长度）就可以得到随机的退避时间。当时隙编号达到255时（对应第6次退避）就不再增加。
![Pasted image](images/Pasted%20image%2020231024103745.png)
为了进一步降低发生碰撞的概率，802.11无线局域网允许源站对信道进行预约
![Pasted image](images/Pasted%20image%2020231024103844.png)
![Pasted image](images/Pasted%20image%2020231024104046.png)
若RTS帧发生碰撞，源站就不可能收到CTS帧，源站会执行退避算法重传RTS帧
![Pasted image](images/Pasted%20image%2020231024104514.png)
![Pasted image](images/Pasted%20image%2020231024104530.png)
使用RTS帧和CTS帧进行信道预约也属于虚拟载波监听机制。利用虚拟载波监听机制，站点只要监听到数据帧、RTS帧或CTS帧中的任何一个，就能知道信道被占用的持续时间，而不需要真正监听到信道上的信号，因此虚拟载波监听机制能减少屏蔽站带来的碰撞问题。

## MAC帧
![Pasted image](images/Pasted%20image%2020231024105827.png)
![Pasted image](images/Pasted%20image%2020231024105942.png)
![Pasted image](images/Pasted%20image%2020231024112453.png)
- 去往DS和来自DS（分配系统）控制位：控制帧头中地址1~地址4的内容和使用情况
- 类型与子类型控制位：区分不同类型的数据帧
- 有线等效保密WEP控制位：指示是否使用了WEP加密算法
- AP具有网桥功能
![Pasted image](images/Pasted%20image%2020231024111554.png)